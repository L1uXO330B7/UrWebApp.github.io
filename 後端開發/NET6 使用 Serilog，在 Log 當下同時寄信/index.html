<!DOCTYPE html>
<html lang="TW">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
    integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
    crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  
<link rel="stylesheet" href="/css/prism.css">
 
  
<link rel="stylesheet" href="/css/main.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <!-- 网站名 -->
  <header>
    <div class="mobileBox">
      <div class="brandBox">
        <a href="/" class="d-flex align-items-center">
          <h1 class="m-0">
            您的網路共筆
          </h1>
        </a>

      </div>
      <a href="#" id="barBtn"><i class="fa-solid fa-bars"></i></a>
    </div>


  </header>
  <!-- <h1>
      <a href="/">Home</a> |
      <a href="/archives">Archive</a> |
      tags
      <a href="/about/">About</a>
    </h1> -->
  <div class="outter-wrap container-fluid">
    <aside class="leftAside">
      <nav>
        <ul>
          <!-- <li>
            <h4>
              <a href="/about/">關於我們</a>
            </h4>
          </li> -->
          <li>
            <h4>
              <a href="#" id="categoriesBtn">文章分類 <i class="fa-solid fa-square-caret-up"></i></a>
            </h4>
            <div id="categories">
              <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/">後端開發</a><span class="category-list-count">1</span></li></ul>
            </div>
          </li>
          <li>
            <h4>
              <a href="#" id="tagsBtn">文章標籤 <i class="fa-solid fa-square-caret-up"></i></a>
            </h4>
            <div id="tags"><a href="/tags/NET/" style="font-size: 10px;">.NET</a> <a href="/tags/Log/" style="font-size: 10px;">Log</a></div>
          </li>
        </ul>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="input-group"><input type="search" name="q" class="input-group-input" placeholder="Search"><button type="submit" class="input-group-submit">Search</button><input type="hidden" name="sitesearch" value="https://urwebapp.github.io"></form>
      </nav>
    </aside>

    <!-- 博客详情 -->
<main class="container postWrap">
  <article class="postArticle">
    <h1 class="pt-5">.NET6 使用 Serilog，在 log 當下同時寄信</h1>

    <div class="infoBox">
      <p>2023/01/04 22:11</p>
      <span>|</span>
      <p>By 凱煞大地
      </p>
      <span>|</span>
      <p>
        
          <a href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/ ">後端開發 </a>
          
      </p>
      <span>|</span>
      <ul class="tagBox">
        
          <li>
            <a href="/tags/Log/"><i class="fa-solid fa-tag"></i> Log
            </a>
          </li>
          
          <li>
            <a href="/tags/NET/"><i class="fa-solid fa-tag"></i> .NET
            </a>
          </li>
          
      </ul>
    </div>
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在專案中，上機測試常常會碰到原本開發上沒遇過的問題，這時候就要環境中留存的 Log 來做 Debug 了。除此之外，當特定的事件發生時，除了要 Log 下來，還要寄信給相關人員時，就可以嘗試使用 Serilog。</p>
<p>如果沒有複雜的 Log 需求時，我推薦使用輕量&#x2F;視覺化的 WatchDog 來做 log 輔助。</p>
<h2 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h2><p>可以在 Nuget 介面安裝或是下指令</p>
<pre class="line-numbers language-console" data-language="console"><code class="language-console">dotnet add package Serilog.AspNetCore &#x2F;&#x2F; 套件包
dotnet add package Serilog.Sinks.Email &#x2F;&#x2F;輸出至Email<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>因為主要是需要在事件發生時紀錄並寄信，所以只安裝相關 Email 套件，如有其他需求時，可以在 Nuget 介面查詢相關字眼</p>
<pre class="line-numbers language-console" data-language="console"><code class="language-console">dotnet add package Serilog.Sinks.Debug
dotnet add package Serilog.Sinks.File
dotnet add package Serilog.Sinks.Seq
dotnet add package Serilog.Sinks.MSSqlServer
dotnet add package Serilog.Settings.Configuration
dotnet add package Serilog.Extensions.Hosting
dotnet add package Serilog.Formatting.Compact
dotnet add package Serilog.Enrichers.Environment
dotnet add package Serilog.Enrichers.Thread<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="在-Program-cs-初始化-Serilog-設定"><a href="#在-Program-cs-初始化-Serilog-設定" class="headerlink" title="在 Program.cs 初始化 Serilog 設定"></a>在 Program.cs 初始化 Serilog 設定</h2><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">using Serilog;
using Serilog.Events;
using Serilog.Sinks.Email;

Log.Logger &#x3D; new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override(&quot;Microsoft.AspNetCore&quot;, LogEventLevel.Warning)
    .Enrich.FromLogContext()
    .WriteTo.Console() &#x2F;&#x2F; Log 寫入 Console
    .WriteTo.File(&quot;logs&#x2F;log-.txt&quot;, rollingInterval: RollingInterval.Day) &#x2F;&#x2F; Log 寫入 TXT 檔，以當日日期為檔名區分
    .WriteTo.Email(new EmailConnectionInfo()
    &#123;
        MailServer &#x3D; &quot;smtp.gmail.com&quot;,
        Port &#x3D; 465,
        EnableSsl &#x3D; true,
        NetworkCredentials &#x3D; new NetworkCredential(&quot;account@gmail.com&quot;, &quot;password&quot;), &#x2F;&#x2F; SMTP 認證帳號跟密碼
        EmailSubject &#x3D; &quot;No-reply Notification&quot;, &#x2F;&#x2F;郵件主旨
        FromEmail &#x3D; &quot;xxxx@gmail.com&quot;, &#x2F;&#x2F;寄件者
        ToEmail &#x3D; &quot;xxxx@gmail.com&quot; &#x2F;&#x2F; 收件者
    &#125;)
    .CreateLogger();
    
    try&#123;
    &#x2F;&#x2F; 其他程式碼
    return 0;
    &#125;
    catch(Exception ex)&#123;
     Log.Fatal(ex, &quot;Host terminated unexpectedly&quot;);
     return 1;
    &#125;
    finally
    &#123;
    Log.CloseAndFlush();
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 <code>finally</code> 中的 <code>Log.CloseAndFlush();</code>，可以讓程式在意外結束中確實寫入 log。</p>
<p>在範例程式碼可看到，可以自行決定要將 Log 寫在本地的 Txt 檔，或是透過郵件來發送，也可以存在 SQL 中(無實作)等等。</p>
<p>透過官方<a target="_blank" rel="noopener" href="https://github.com/serilog/serilog/wiki/Writing-Log-Events">Github wiki</a>可以知道 Serilog 有提供靜態類別 Log 可用在專案的任何地方，在使用之前要先設定好 Log.Logger。</p>
<h3 id="靜態類別-Log-使用方式"><a href="#靜態類別-Log-使用方式" class="headerlink" title="靜態類別 Log 使用方式"></a>靜態類別 Log 使用方式</h3><pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Log.Verbose(&quot;紀錄&quot;); &#x2F;&#x2F; 詳細資訊
Log.Debug(&quot;紀錄&quot;);
Log.Information(&quot;紀錄&quot;); &#x2F;&#x2F; 使用者層級
Log.Warning(&quot;紀錄&quot;);
Log.Error(&quot;紀錄&quot;);
Log.Fatal(&quot;紀錄&quot;); <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Log-Event-Level"><a href="#Log-Event-Level" class="headerlink" title="Log Event Level"></a>Log Event Level</h3><p>另外，Serilog <a target="_blank" rel="noopener" href="https://github.com/serilog/serilog/blob/dev/src/Serilog/Events/LogEventLevel.cs">事件層級</a>有6個，分別是 <code>Verbose = 0</code>，<code> Debug = 1</code>， <code>Information = 2</code>， <code>Warning = 3</code>，<code>Error = 4</code>，<code>Fatal = 5</code>。</p>
<p>在上面的範例程式碼中的，<code>MinimumLevel</code> 是顯示的最低事件層級，預設是<code>Information</code>，可設定為<code>MinimumLevel.Debug()</code>、<code>MinimumLevel.Verbose()</code>等等，log事件會從該層級開始依序顯示。</p>
<h2 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h2><p>可以用剛剛的靜態類別 Log 來幫助測試，或者也可以故意在程式碼中來埋下錯誤實驗。</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">try
  &#123;
    Log.Fatal(&quot;Host terminated unexpectedly&quot;);
    int.Parse(&quot;錯誤&quot;);
    return &quot;success&quot;;
  &#125;
catch (Exception ex)
  &#123;
    throw ex;
  &#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>過不久就可以收到郵件了，也可以在專案中看見 Log 資料夾。<br><img src="https://i.imgur.com/su8O8Jy.png" alt="log"></p>
<h2 id="進階用法"><a href="#進階用法" class="headerlink" title="進階用法"></a>進階用法</h2><p>因為需要動態填入收信者，所以需在 Nuget 或下指令多安裝</p>
<pre class="line-numbers language-console" data-language="console"><code class="language-console">dotnet add package Serilog.Sinks.Map &#x2F;&#x2F; 在 Config 中使用變數<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安裝完後，剛剛在 Program.cs 的設定需要調整一下</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">Log.Logger &#x3D; new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override(&quot;Microsoft.AspNetCore&quot;, LogEventLevel.Warning)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File(&quot;logs&#x2F;log-.txt&quot;, rollingInterval: RollingInterval.Day)
    .WriteTo.Map(&quot;Address&quot;, &quot;default@gmail.com&quot;, (address, wt) &#x3D;&gt; wt.Email(new EmailConnectionInfo()
    &#123;
        MailServer &#x3D; &quot;smtp.gmail.com&quot;,
        Port &#x3D; 465,
        EnableSsl &#x3D; true,
        NetworkCredentials &#x3D; new NetworkCredential(&quot;xxxx@gmail.com&quot;, &quot;xxxx&quot;),
        EmailSubject &#x3D; &quot;Notification&quot;,
        FromEmail &#x3D; &quot;xxxx@gmail.com&quot;,
        ToEmail &#x3D; address,
    &#125;))
    .CreateLogger();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要差異在於下面這段</p>
<pre class="line-numbers language-c#" data-language="c#"><div class="caption"><span>!</span></div><code class="language-c#">.WriteTo.Map(&quot;Address&quot;, &quot;default@gmail.com&quot;, (address, wt) &#x3D;&gt; wt.Email(new EmailConnectionInfo()&#123;...&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>以下皆可自行取名<br><code>Address</code>: 可以在靜態方法 Log 中使用。<br><code>default@gmail.com</code>: 此參數為預設值，會帶進右方括弧中第一個參數。<br><code>address</code>: 可在箭頭函式使用的變數，由靜態方法 Log 的地個參數傳回。<br><code>wt</code>: 為 <code>WriteTo</code>。</p>
<p>接著使用靜態方法 Log 時，就可以寄給不同對象。</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">try
            &#123;

                Log.Fatal(&quot;Error&quot;); &#x2F;&#x2F; 預設收件者
                Log.Fatal(&quot;Host terminated unexpectedly &#123;Address&#125;&quot;, &quot;test1.com.tw&quot;);
                Log.Fatal(&quot;Host terminated unexpectedly &#123;Address&#125;&quot;, &quot;test2.com.tw&quot;);

                int.Parse(&quot;錯誤&quot;);
                return &quot;success&quot;;
            &#125;
            catch (Exception ex)
            &#123;
                throw ex;
            &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料:"></a>參考資料:</h2><p><a target="_blank" rel="noopener" href="https://github.com/serilog/serilog/wiki">Serilog</a><br><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2021/11/29/How-to-use-Serilog-with-NET-6">.NET 6.0 如何使用 Serilog 對應用程式事件進行結構化紀錄</a><br><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10295821">ASP.NET Core 30 天旅程</a></p>

      
  </article>
  <div class="d-flex justify-content-between mt-5">
        
            
      </div>
</main>
      
        <aside class="rightAside">
          <section>
            <h4>文章大綱</h4>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%9D%E6%AD%A5%E9%A9%9F"><span class="toc-text">安裝步驟</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-Program-cs-%E5%88%9D%E5%A7%8B%E5%8C%96-Serilog-%E8%A8%AD%E5%AE%9A"><span class="toc-text">在 Program.cs 初始化 Serilog 設定</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9C%E6%85%8B%E9%A1%9E%E5%88%A5-Log-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">靜態類別 Log 使用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Log-Event-Level"><span class="toc-text">Log Event Level</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%AC%E8%A9%A6"><span class="toc-text">測試</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%B2%E9%9A%8E%E7%94%A8%E6%B3%95"><span class="toc-text">進階用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="toc-text">參考資料:</span></a></li></ol>
          </div>
        </section>
        

  </div>
  <footer class="cotainer-fluid">
    <p class="text-center m-0">Copyright © 2023 UrWeb. All rights reserved.

    </p>
  </footer>



  <!-- <h3>categories</h3>
    <ul>
      
      <li>
        <a href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/"> 後端開發  </a>
      </li>
      
    </ul>

    <h3>tags</h3>
    <ul>
      
      <li>
        <a href="/tags/Log/"> Log </a>
      </li>
      
      <li>
        <a href="/tags/NET/"> .NET </a>
      </li>
      
    </ul> -->
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="/js/prism.js"></script>
 

<script src="/js/main.js"></script>


</html>